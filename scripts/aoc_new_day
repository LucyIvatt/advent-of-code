#!/bin/bash

# Require env var
if [ -z "$AOC_SOLUTION_REPO" ]; then
    echo "ERROR: AOC_SOLUTION_REPO must be set in the environment."
    exit 1
fi

Help() {
    echo "Usage: $0 <day_num> <task_name> <year> <language>"
    echo "  day_num     Day number (01–25)"
    echo "  task_name   Task name (cube_conundrum, camp_cleanup…)"
    echo "  year        Year (e.g., 2025)"
    echo "  language    py or ts"
}

# Check args
if [ "$#" -ne 4 ]; then
    Help
    exit 1
fi

day_num="$1"
task_name="$2"
year="$3"
language="$4"

# Build base paths inside the solution repo
if [ "$language" = "py" ]; then
    year_folder="$AOC_SOLUTION_REPO/python/year_$year"
    template_folder="$AOC_SOLUTION_REPO/python/template"
elif [ "$language" = "ts" ]; then
    year_folder="$AOC_SOLUTION_REPO/typescript/year_$year"
    template_folder="$AOC_SOLUTION_REPO/typescript/template"
else
    echo "ERROR: Unsupported language: $language"
    exit 1
fi

day_folder="$year_folder/day_${day_num}_${task_name}"

# Create year folder — and __init__.py if it didn't exist before
if [ ! -d "$year_folder" ]; then
    mkdir -p "$year_folder"
    if [ "$language" = "py" ]; then
        touch "$year_folder/__init__.py"
        echo "Created $year_folder/__init__.py"
    fi
fi

# Create day directory
mkdir -p "$day_folder"

# Copy templates into place
cp -rv "$template_folder/"* "$day_folder"

# Create empty input files
touch "$day_folder/example.txt"
touch "$day_folder/input.txt"

# Render templates
if [ "$language" = "py" ]; then
    jinja2 "$day_folder/solution.py.j2" -o "$day_folder/solution.py" \
        -D day_num="$day_num" -D task_name="$task_name" -D year="$year"

    jinja2 "$day_folder/test.py.j2" -o "$day_folder/test.py" \
        -D day_num="$day_num" -D task_name="$task_name" -D year="$year"

    rm -v "$day_folder/solution.py.j2" "$day_folder/test.py.j2"
else
    jinja2 "$day_folder/solution.ts.j2" -o "$day_folder/solution.ts" \
        -D day_num="$day_num" -D task_name="$task_name" -D year="$year"

    jinja2 "$day_folder/solution.spec.ts.j2" -o "$day_folder/solution.spec.ts" \
        -D day_num="$day_num" -D task_name="$task_name" -D year="$year"

    rm -v "$day_folder/solution.ts.j2" "$day_folder/solution.spec.ts.j2"
fi
